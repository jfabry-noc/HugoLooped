<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>kinit Fails Only When Using Keytab File :: LoopedNetwork</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Lately I&amp;rsquo;ve been working through getting WinRM connectivity working between a Linux container and a bunch of Windows servers. I&amp;rsquo;m using the venerable pywinrm library. It works great, but there was a decent bit of setup for the underlying host to make it work that I had been unfamiliar with; you can&amp;rsquo;t just create a client object, plug in some credentials, and go. A big part of this for my setup was configuring krb5 to be able to speak to Active Directory appropriately." />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://looped.network/posts/kinit-keytab-fail/" />






  
  
  
  
  
  <link rel="stylesheet" href="https://looped.network/styles.css">







  <link rel="shortcut icon" href="https://looped.network/favicon.ico">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="kinit Fails Only When Using Keytab File">
<meta property="og:description" content="Lately I&amp;rsquo;ve been working through getting WinRM connectivity working between a Linux container and a bunch of Windows servers. I&amp;rsquo;m using the venerable pywinrm library. It works great, but there was a decent bit of setup for the underlying host to make it work that I had been unfamiliar with; you can&amp;rsquo;t just create a client object, plug in some credentials, and go. A big part of this for my setup was configuring krb5 to be able to speak to Active Directory appropriately." />
<meta property="og:url" content="https://looped.network/posts/kinit-keytab-fail/" />
<meta property="og:site_name" content="LoopedNetwork" />

  
    <meta property="og:image" content="https://looped.network/favicon.ico">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2022-09-07 18:26:27 -0400 EDT" />












</head>
<body class="pink">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    LoopedNetwork
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about">About</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://looped.network/posts/kinit-keytab-fail/">kinit Fails Only When Using Keytab File</a>
  </h1>
  <div class="post-meta">
    
      <time class="post-date">
        2022-09-07 ::
        
      </time>
    
    
    
      <span class="post-reading-time">:: 3 min read (563 words)</span>
    
  </div>

  
    <span class="post-tags">
      
      #<a href="https://looped.network/tags/kinit/">kinit</a>&nbsp;
      
      #<a href="https://looped.network/tags/keytab/">keytab</a>&nbsp;
      
      #<a href="https://looped.network/tags/kerberos/">Kerberos</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <p>Lately I&rsquo;ve been working through getting WinRM connectivity working between a Linux container and a bunch of Windows servers. I&rsquo;m using the venerable <a href="https://pypi.org/project/pywinrm/">pywinrm library</a>. It works <em>great</em>, but there was a decent bit of setup for the underlying host to make it work that I had been unfamiliar with; you can&rsquo;t just create a client object, plug in some credentials, and go. A big part of this for my setup was configuring <a href="https://pkgs.alpinelinux.org/package/edge/main/aarch64/krb5">krb5</a> to be able to speak to Active Directory appropriately.</p>
<p>My setup involves a container that runs an SSH server which another, external service actually SSHs into in order to execute various pieces of code. So my idea was to take the entrypoint script that configures the SSH server and have it also both:</p>
<ol>
<li>Create a keytab file.</li>
<li>Use it to get a TGT.</li>
<li>Create a <code>cron</code> job to keep it refreshed.</li>
</ol>
<p>Let&rsquo;s pretend the AD account I had been given to use was:</p>
<p><strong><a href="mailto:Username@sub.domain.com">Username@sub.domain.com</a></strong></p>
<p>In my manual testing, this worked fine after I was prompted for the password:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kinit Username@SUB.DOMAIN.COM
</span></span></code></pre></div><p>If you&rsquo;re completely new to this, note that it&rsquo;s actually critical that the domain (more appropriately called the &ldquo;realm&rdquo; in this case) is in all capital letters. If I run this manually by <code>exec</code>ing my way into a container, I get a TGT just like I&rsquo;d expect. I can view it via:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>klist -e
</span></span></code></pre></div><p>Unfortunately, things didn&rsquo;t go smoothly when I tried to use a keytab file. I created one in my entrypoint shell script via a function that runs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;addent -password -p Username@SUB.DOMAIN.COM -k 1 -e aes256-cts-hmac-sha1-96&#34;</span>
</span></span><span style="display:flex;"><span>    sleep <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    echo &lt;password&gt;
</span></span><span style="display:flex;"><span>    sleep <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;wkt /file.keytab&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> | ktutil &amp;&gt; /dev/null
</span></span></code></pre></div><p>The keytab file is created successfully, but as soon as I try to leverage it with&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kinit Username@SUB.DOMAIN.COM -kt /file.keytab
</span></span></code></pre></div><p>&hellip;I receive a Kerberos preauthentication error. After much confusion and searching around online, I finally found an <a href="https://community.cloudera.com/t5/Community-Articles/quot-kinit-Preauthentication-failed-while-getting-initial/ta-p/346998">article</a> that got me on the right track.</p>
<p>The article discusses the fact that an assumption is being made under the hood that the salt being used to encrypt the contents of the keytab file is the realm concatenated together with the user&rsquo;s samAccountName (aka &ldquo;shortname&rdquo;). So for my sample account, the salt value would be:</p>
<p><strong>SUB.DOMAIN.COMUsername</strong></p>
<p>The problem highlighted by the article is that when you authenticate via the UserPrincipalName format (e.g.: <a href="mailto:username@domain.com">username@domain.com</a>) rather than the shortname format (e.g.: domain\username), another assumption is made that the prefix of the UPN is the same as the shortname. This is very commonly not the case; in a previous life where I actually was the AD sysadmin, I had shortnames of first initial and last name while the UPNs were actually firstname dot lastname. So for example, my UPN was:</p>
<p><strong><a href="mailto:looped.network@domain.com">looped.network@domain.com</a></strong></p>
<p>While my samAccountName was:</p>
<p><strong>lnetwork</strong></p>
<p>If this type of mismatch happens, you can use <code>-s</code> when running <code>addent</code> to specify the salt. After checking AD, I verified in my current case that the username was the same for both properties&hellip; but that in both places it was completely <em>lowercase</em>. I can&rsquo;t say why it was given to me with the first character capitalized, but after re-trying with <strong><a href="mailto:username@SUB.DOMAIN.COM">username@SUB.DOMAIN.COM</a></strong>, everything was successful. This made sense to me because while AD doesn&rsquo;t care about the username&rsquo;s capitalization when it authenticates (hence why manually running <code>kinit</code> and typing the password worked), using a keytab file means that the wrong salt was given.</p>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://looped.network/posts/kubectl-symbolic-link-error/">
                <span class="button__icon">←</span>
                <span class="button__text">kubectl logs Symbolic Link Error</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://looped.network/posts/neovim-lsp/">
                <span class="button__text">Real Time Error Checking and Code Completion With Neovim</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2023 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
